---
title: 3.6.0 RAC-config storage
date: 2016-12-22 14:50:00
categories: database/oracle
tags: [database,oracle]
---
### 3.6.0 RAC-config storage

---

### 1. 存储配置
接下来的存储配置会提供关于以下内容的推荐配置
- 设置设备的多路径映射
- 为ASM 硬盘管理使用udev规则或者oracle的ASMLib
- 为了最佳性能而使用的tuned package

#### 1) 设置DM-Multipath
设备多路径映射提供了聚合多个I/O路径来实现高可用，I/O负载均衡和命名持久化的能力。

> 注意，在进行一下步骤之前，先确保每个节点都可以访问oracle集群的共享存储。如果是虚拟机环境，请先创建共享磁盘，并挂在到每个模拟节点上

以下是安装和配置设备多路径映射设备的推荐步骤
``` bash
# 安装device-mapper-multipath
yum install device-mapper-multipath

# 准备配置文件
cp /usr/share/doc/device-mapper-multipath-0.4.9/multipath.conf /etc/

# 获取本地硬盘在系统中的scsi id
scsi_id --whitelisted --replace-whitespace --device=/dev/sda
1ATA_VBOX_HARDDISK_VB542a6eee-dbfb1007


# 修改配置文件，将上面的scsi id加入黑名单
vim /etc/multipath.conf
******************************************************
# virtualbox虚拟环境中，这里必须添加getuid_callout字段中的"--replace-whitespace"，因为上面的scsi_id拥有"_"
defaults {
        getuid_callout          "/lib/udev/scsi_id --whitelisted --replace-whitespace --device=/dev/%n"
        user_friendly_names     yes
}

# 禁掉本地磁盘
blacklist {
       wwid 1ATA_VBOX_HARDDISK_VB542a6eee-dbfb1007
        devnode "^(ram|raw|loop|fd|md|dm-|sr|scd|st)[0-9]*"
        devnode "^hd[a-z]"
}
******************************************************

# 重启服务
service multipathd start

# 设置开机启动服务
chkconfig multipathd on

# 查看
multipath -ll
db2 (1ATA_VBOX_HARDDISK_VBa522109e-6e7ba34d) dm-3 ATA,VBOX HARDDISK
size=8.0G features='0' hwhandler='0' wp=rw
`-+- policy='round-robin 0' prio=1 status=active
 `- 4:0:0:0 sdc 8:32  active ready running
db1 (1ATA_VBOX_HARDDISK_VB5fd07f22-14a65bd2) dm-2 ATA,VBOX HARDDISK
size=10G features='0' hwhandler='0' wp=rw
`-+- policy='round-robin 0' prio=1 status=active
 `- 3:0:0:0 sdb 8:16  active ready running
redo (1ATA_VBOX_HARDDISK_VB1bf7dcf2-cc7766bf) dm-5 ATA,VBOX HARDDISK
size=8.0G features='0' hwhandler='0' wp=rw
`-+- policy='round-robin 0' prio=1 status=active
 `- 6:0:0:0 sde 8:64  active ready running
fra (1ATA_VBOX_HARDDISK_VB1f2e19af-e712c25a) dm-4 ATA,VBOX HARDDISK
size=8.0G features='0' hwhandler='0' wp=rw
`-+- policy='round-robin 0' prio=1 status=active
 `- 5:0:0:0 sdd 8:48  active ready running
ocrvote3 (1ATA_VBOX_HARDDISK_VBce272003-a253f798) dm-8 ATA,VBOX HARDDISK
size=1.0G features='0' hwhandler='0' wp=rw
`-+- policy='round-robin 0' prio=1 status=active
 `- 9:0:0:0 sdh 8:112 active ready running
ocrvote2 (1ATA_VBOX_HARDDISK_VB96b54a9f-d8e3fcce) dm-7 ATA,VBOX HARDDISK
size=1.0G features='0' hwhandler='0' wp=rw
`-+- policy='round-robin 0' prio=1 status=active
 `- 8:0:0:0 sdg 8:96  active ready running
ocrvote1 (1ATA_VBOX_HARDDISK_VBa47c63dc-5db76100) dm-6 ATA,VBOX HARDDISK
size=1.0G features='0' hwhandler='0' wp=rw
`-+- policy='round-robin 0' prio=1 status=active
 `- 7:0:0:0 sdf 8:80  active ready running


# 进一步配置
vim /etc/multipath.conf
******************************************************
# 正式环境应该如此配置，但是virtualbox磁盘似乎不支持alua方式，所以prio项在测试环境中需要注释
defaults {
 udev_dir /dev
 polling_interval 10
 path_selector "round-robin 0"
 path_grouping_policy multibus
 getuid_callout "/lib/udev/scsi_id --whitelisted --device=/dev/%n"
 prio alua
 path_checker readsector0
 rr_min_io 100
 max_fds 8192
 rr_weight priorities
 failback immediate
 no_path_retry fail
 user_friendly_names yes
}
# prio字段
# 作用：Specifies the default function to call to obtain a path priority value.
# Possible values include:
#     const: Set a priority of 1 to all paths.
#     emc: Generate the path priority for EMC arrays.
#     alua: Generate the path priority based on the SCSI-3 ALUA settings.
#     netapp: Generate the path priority for NetApp arrays.
#     rdac: Generate the path priority for LSI/Engenio RDAC controller.
#     hp_sw: Generate the path priority for Compaq/HP controller in active/standby mode.
#     hds: Generate the path priority for Hitachi HDS Modular storage arrays.
#     The default value is const.

## 添加一下别名
multipaths {
        multipath {
                wwid                    1ATA_VBOX_HARDDISK_VB5fd07f22-14a65bd2
                alias                   db1
        }
        multipath {
                wwid                    1ATA_VBOX_HARDDISK_VBa522109e-6e7ba34d
                alias                   db2
        }
        multipath {
                wwid                    1ATA_VBOX_HARDDISK_VB1f2e19af-e712c25a
                alias                   fra
        }
        multipath {
                wwid                    1ATA_VBOX_HARDDISK_VB1bf7dcf2-cc7766bf
                alias                   redo
        }
        multipath {
                wwid                    1ATA_VBOX_HARDDISK_VBa47c63dc-5db76100
                alias                   ocrvote1
        }
        multipath {
                wwid                    1ATA_VBOX_HARDDISK_VB96b54a9f-d8e3fcce
                alias                   ocrvote2
        }
        multipath {
                wwid                    1ATA_VBOX_HARDDISK_VBce272003-a253f798
                alias                   ocrvote3
        }
}

# 此处的wwid是需要共享的磁盘的scsi_id，一共7个磁盘
******************************************************

# 重启服务
service multipathd restart

# 查看状态
cat /etc/multipath/bindings
# Multipath bindings, Version : 1.0
# NOTE: this file is automatically maintained by the multipath program.
# You should not need to edit this file in normal circumstances.
#
# Format:
# alias wwid
#
mpatha 1ATA_VBOX_HARDDISK_VB5fd07f22-14a65bd2

multipath -ll
db2 (1ATA_VBOX_HARDDISK_VBa522109e-6e7ba34d) dm-3 ATA,VBOX HARDDISK
size=8.0G features='0' hwhandler='0' wp=rw
`-+- policy='round-robin 0' prio=1 status=active
 `- 4:0:0:0 sdc 8:32  active ready running
db1 (1ATA_VBOX_HARDDISK_VB5fd07f22-14a65bd2) dm-2 ATA,VBOX HARDDISK
size=10G features='0' hwhandler='0' wp=rw
`-+- policy='round-robin 0' prio=1 status=active
 `- 3:0:0:0 sdb 8:16  active ready running
redo (1ATA_VBOX_HARDDISK_VB1bf7dcf2-cc7766bf) dm-5 ATA,VBOX HARDDISK
size=8.0G features='0' hwhandler='0' wp=rw
`-+- policy='round-robin 0' prio=1 status=active
 `- 6:0:0:0 sde 8:64  active ready running
fra (1ATA_VBOX_HARDDISK_VB1f2e19af-e712c25a) dm-4 ATA,VBOX HARDDISK
size=8.0G features='0' hwhandler='0' wp=rw
`-+- policy='round-robin 0' prio=1 status=active
 `- 5:0:0:0 sdd 8:48  active ready running
ocrvote3 (1ATA_VBOX_HARDDISK_VBce272003-a253f798) dm-8 ATA,VBOX HARDDISK
size=1.0G features='0' hwhandler='0' wp=rw
`-+- policy='round-robin 0' prio=1 status=active
 `- 9:0:0:0 sdh 8:112 active ready running
ocrvote2 (1ATA_VBOX_HARDDISK_VB96b54a9f-d8e3fcce) dm-7 ATA,VBOX HARDDISK
size=1.0G features='0' hwhandler='0' wp=rw
`-+- policy='round-robin 0' prio=1 status=active
 `- 8:0:0:0 sdg 8:96  active ready running
ocrvote1 (1ATA_VBOX_HARDDISK_VBa47c63dc-5db76100) dm-6 ATA,VBOX HARDDISK
size=1.0G features='0' hwhandler='0' wp=rw
`-+- policy='round-robin 0' prio=1 status=active
 `- 7:0:0:0 sdf 8:80  active ready running
```
